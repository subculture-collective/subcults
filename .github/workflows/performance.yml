name: Performance Budget & Lighthouse CI

on:
  pull_request:
    paths:
      - 'web/**'
      - 'lighthouserc.json'
      - '.github/workflows/performance.yml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'web/**'
      - 'lighthouserc.json'

jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for bundle size comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            web/package-lock.json
            package-lock.json

      - name: Install root dependencies
        run: npm ci

      - name: Install frontend dependencies
        run: |
          cd web
          npm ci

      - name: Build frontend
        run: |
          cd web
          npm run build
        env:
          # Set production env vars for build
          NODE_ENV: production

      - name: Run Lighthouse CI
        run: npx @lhci/cli@0.13.x autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: .lighthouseci
          retention-days: 30

      - name: Check bundle size
        run: |
          cd web
          # Generate bundle analysis
          npm run build

          # Check if stats file exists
          if [ -f "dist/stats.html" ]; then
            echo "‚úÖ Bundle analysis generated at dist/stats.html"

            # Extract and display key metrics (gzipped sizes)
            echo "üìä Bundle size analysis:"
            find dist -name "*.js" -o -name "*.css" | while read file; do
              size=$(du -h "$file" | cut -f1)
              echo "  - $file: $size"
            done
          else
            echo "‚ö†Ô∏è Bundle analysis file not found"
          fi

      - name: Upload bundle stats
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats
          path: web/dist/stats.html
          retention-days: 30

  performance-budgets:
    name: Performance Budget Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd web
          npm ci

      - name: Build frontend
        run: |
          cd web
          npm run build

      - name: Check bundle sizes
        run: |
          cd web/dist

          echo "üì¶ Checking bundle sizes against budgets..."
          echo ""

          # Define budgets (in KB, gzipped)
          MAIN_JS_BUDGET=200
          MAIN_CSS_BUDGET=50
          VENDOR_JS_BUDGET=300
          TOTAL_JS_BUDGET=500

          # Calculate actual sizes (gzipped)
          total_js=0
          budget_exceeded=0

          # Check main JS bundles
          for file in assets/*.js; do
            if [ -f "$file" ]; then
              # Get gzipped size in KB
              size=$(gzip -c "$file" | wc -c | awk '{print int($1/1024)}')
              total_js=$((total_js + size))

              filename=$(basename "$file")
              echo "  üìÑ $filename: ${size}KB"

              # Check if it's the main bundle (usually contains "index")
              if [[ "$filename" == *"index"* ]]; then
                if [ $size -gt $MAIN_JS_BUDGET ]; then
                  echo "    ‚ùå Exceeds main JS budget of ${MAIN_JS_BUDGET}KB"
                  budget_exceeded=1
                else
                  echo "    ‚úÖ Within main JS budget"
                fi
              fi
            fi
          done

          # Check CSS bundles
          for file in assets/*.css; do
            if [ -f "$file" ]; then
              size=$(gzip -c "$file" | wc -c | awk '{print int($1/1024)}')
              filename=$(basename "$file")
              echo "  üé® $filename: ${size}KB"

              if [ $size -gt $MAIN_CSS_BUDGET ]; then
                echo "    ‚ö†Ô∏è Exceeds CSS budget of ${MAIN_CSS_BUDGET}KB"
              else
                echo "    ‚úÖ Within CSS budget"
              fi
            fi
          done

          # Check total JS size
          echo ""
          echo "üìä Total JavaScript: ${total_js}KB (budget: ${TOTAL_JS_BUDGET}KB)"

          if [ $total_js -gt $TOTAL_JS_BUDGET ]; then
            echo "‚ùå Total JS exceeds budget!"
            budget_exceeded=1
          else
            echo "‚úÖ Total JS within budget"
          fi

          # Exit with error if budget exceeded
          if [ $budget_exceeded -eq 1 ]; then
            echo ""
            echo "üí• Performance budget exceeded! Review and optimize bundle size."
            exit 1
          else
            echo ""
            echo "‚úÖ All performance budgets met!"
          fi
